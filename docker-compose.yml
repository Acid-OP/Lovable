services:
  traefik:
    image: traefik:v2.10
    container_name: lovable-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=lovable_sandbox-network"
      - "--entrypoints.web.address=:80"
    ports:
      - "3003:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sandbox-network
    restart: unless-stopped

  http:
    build:
      context: .
      dockerfile: Docker/Dockerfile.http
    container_name: lovable-http
    ports:
      - "3001:3001"
    networks:
      - backend-network
      - sandbox-network
    environment:
      - PORT=3001
      - CONTAINER_PORT=3003
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - DATABASE_URL=${DATABASE_URL}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      - LLM_TOP_P=${LLM_TOP_P}
      - DOCKER_NETWORK=lovable_sandbox-network
    env_file:
      - .env
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  orchestrator:
    build:
      context: .
      dockerfile: Docker/Dockerfile.orchestrator
    container_name: lovable-orchestrator
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - REDIS_HOST=host.docker.internal
      - REDIS_PORT=6379
      - HTTP_SERVICE_URL=http://host.docker.internal:3001
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      - LLM_TOP_P=${LLM_TOP_P}
      - DOCKER_NETWORK=lovable_sandbox-network
      - DOCKER_SOCKET=/var/run/docker.sock
    env_file:
      - .env
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  backend-network:
    driver: bridge
    internal: false
  sandbox-network:
    driver: bridge
    internal: false
